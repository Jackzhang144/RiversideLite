name: Edge Add-on Upload

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  upload:
    runs-on: ubuntu-latest
    env:
      EDGE_CLIENT_ID: ${{ secrets.EDGE_CLIENT_ID }}
      EDGE_API_KEY: ${{ secrets.EDGE_API_KEY }}
      EDGE_PRODUCT_ID: ${{ secrets.EDGE_PRODUCT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pack extension
        run: |
          mkdir -p dist
          zip -r dist/edge-package.zip \
            manifest.json background.js popup.js popup.html options.js options.html River.png README.md

      - name: Submit package
        id: submit
        run: |
          BODY_FILE=$(mktemp)
          HEADER_FILE=$(mktemp)
          HTTP_STATUS=$(
            curl -sS -w "%{http_code}" \
              -D "$HEADER_FILE" \
              -H "Authorization: ApiKey $EDGE_API_KEY" \
              -H "X-ClientID: $EDGE_CLIENT_ID" \
              -F "file=@dist/edge-package.zip;type=application/zip" \
              -o "$BODY_FILE" \
              "https://api.addons.microsoftedge.microsoft.com/v1/products/$EDGE_PRODUCT_ID/submissions"
          )
          echo "Upload HTTP status: $HTTP_STATUS"
          echo "Upload response headers:"
          cat "$HEADER_FILE"
          echo
          echo "Upload response body:"
          cat "$BODY_FILE"
          echo
          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "Upload failed with status $HTTP_STATUS"
            exit 1
          fi
          SUBMISSION_ID=$(jq -r '.id // .submissionId // .value // .SubmissionId // empty' "$BODY_FILE")
          if [ -z "$SUBMISSION_ID" ]; then
            LOC=$(grep -i "^Location:" "$HEADER_FILE" | awk '{print $2}' | tr -d '\r')
            if [ -n "$LOC" ]; then
              SUBMISSION_URL="$LOC"
              SUBMISSION_ID=$(echo "$LOC" | awk -F'/' '{print $NF}')
            fi
          fi
          if [ -z "$SUBMISSION_ID" ]; then
            echo "No submission id in response"
            exit 1
          fi
          echo "submission_id=$SUBMISSION_ID" >> "$GITHUB_OUTPUT"
          if [ -n "$SUBMISSION_URL" ]; then
            echo "submission_url=$SUBMISSION_URL" >> "$GITHUB_OUTPUT"
          else
            echo "submission_url=https://api.addons.microsoftedge.microsoft.com/v1/products/$EDGE_PRODUCT_ID/submissions/$SUBMISSION_ID" >> "$GITHUB_OUTPUT"
          fi

      - name: Poll submission status
        env:
          SUBMISSION_ID: ${{ steps.submit.outputs.submission_id }}
          SUBMISSION_URL: ${{ steps.submit.outputs.submission_url }}
        run: |
          for i in {1..20}; do
            STATUS_BODY=$(mktemp)
            STATUS_CODE=$(
              curl -sS -w "%{http_code}" \
                -H "Authorization: ApiKey $EDGE_API_KEY" \
                -H "X-ClientID: $EDGE_CLIENT_ID" \
                -o "$STATUS_BODY" \
                "${SUBMISSION_URL:-https://api.addons.microsoftedge.microsoft.com/v1/products/$EDGE_PRODUCT_ID/submissions/$SUBMISSION_ID}"
            )
            echo "Poll attempt $i, HTTP $STATUS_CODE"
            cat "$STATUS_BODY"
            echo
            if [ "$STATUS_CODE" -eq 404 ]; then
              echo "Submission not found (404), stopping."
              exit 1
            fi
            STATUS=$(jq -r '.status // empty' "$STATUS_BODY")
            echo "Status: ${STATUS:-unknown}"
            case "$STATUS" in
              Complete) exit 0 ;;
              Failed) echo "Submission failed"; exit 1 ;;
            esac
            sleep 30
          done
          echo "Timed out"; exit 1

      # 如果需要立即发布，取消下一步注释；部分帐号可能审核通过后需单独 publish
      # - name: Publish
      #   env:
      #     EDGE_API_KEY: ${{ env.EDGE_API_KEY }}
      #     EDGE_CLIENT_ID: ${{ env.EDGE_CLIENT_ID }}
      #   run: |
      #     curl -sS -f -X POST \
      #       -H "Authorization: ApiKey $EDGE_API_KEY" \
      #       -H "X-ClientID: $EDGE_CLIENT_ID" \
      #       "https://api.addons.microsoftedge.microsoft.com/v1/products/$EDGE_PRODUCT_ID/publish"
